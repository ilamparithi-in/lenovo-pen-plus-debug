Subject: [PATCH] fix: previous toggles fixed in lenovo pen mapping
feat: lpp - Toggle OFF on lift
feat: add lenovo pen (plus) button mapper
---
Index: .gitignore
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.gitignore b/.gitignore
--- a/.gitignore	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/.gitignore	(revision 29b7982ba006a6eb936316d422eaba6c6dd344f7)
@@ -7,6 +7,9 @@
 *.apk
 *.so
 .externalNativeBuild
+*.class
+bin/
+*/bin/
 
 # Crashlytics configuations
 com_crashlytics_export_strings.xml
@@ -24,6 +27,9 @@
 .idea/
 *.iml
 
+# VSCode
+.vscode/
+
 # OS-specific files
 .DS_Store
 .DS_Store?
Index: app/src/main/java/com/termux/x11/LoriePreferences.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/termux/x11/LoriePreferences.java b/app/src/main/java/com/termux/x11/LoriePreferences.java
--- a/app/src/main/java/com/termux/x11/LoriePreferences.java	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/app/src/main/java/com/termux/x11/LoriePreferences.java	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
@@ -29,6 +29,7 @@
 import androidx.core.content.ContextCompat;
 import androidx.preference.ListPreference;
 import androidx.preference.Preference;
+import androidx.preference.SwitchPreferenceCompat;
 
 import android.os.Handler;
 import android.os.IBinder;
@@ -291,6 +292,13 @@
             setVisible("showStylusClickOverride", stylusAvailable);
             setVisible("stylusIsMouse", stylusAvailable);
             setVisible("stylusButtonContactModifierMode", stylusAvailable);
+            setVisible("lenovoPenMappingEntry", stylusAvailable);
+
+            setLenovoPenToggleSummary("lenovoPenSinglePressToggle");
+            setLenovoPenToggleSummary("lenovoPenDoublePressToggle");
+            setLenovoPenToggleSummary("lenovoPenTriplePressToggle");
+            setLenovoPenToggleSummary("lenovoPenLongPressToggle");
+            setLenovoPenToggleSummary("lenovoPenLongPressClickToggle");
 
             setNoActionOptionText(findPreference("volumeDownAction"), "android volume control");
             setNoActionOptionText(findPreference("volumeUpAction"), "android volume control");
@@ -307,6 +315,16 @@
                 });
         }
 
+        private void setLenovoPenToggleSummary(CharSequence key) {
+            Preference pref = findPreference(key);
+            if (pref instanceof SwitchPreferenceCompat) {
+                ((SwitchPreferenceCompat) pref).setSummaryProvider(p -> {
+                    boolean checked = ((SwitchPreferenceCompat) p).isChecked();
+                    return getString(checked ? R.string.pref_lenovoPenToggleSummary_on : R.string.pref_lenovoPenToggleSummary_off);
+                });
+            }
+        }
+
         private void setVisible(CharSequence key, boolean value) {
             Preference p = findPreference(key);
             if (p != null)
@@ -350,12 +368,26 @@
             setEnabled("scaleTouchpad", "1".equals(prefs.touchMode.get()) && !"native".equals(prefs.displayResolutionMode.get()));
             setEnabled("showMouseHelper", "1".equals(prefs.touchMode.get()));
 
+            updateLenovoPenGestureLayout("lenovoPenSinglePressAction", "lenovoPenSinglePressToggle", "lenovoPenSinglePressDurationMs");
+            updateLenovoPenGestureLayout("lenovoPenDoublePressAction", "lenovoPenDoublePressToggle", "lenovoPenDoublePressDurationMs");
+            updateLenovoPenGestureLayout("lenovoPenTriplePressAction", "lenovoPenTriplePressToggle", "lenovoPenTriplePressDurationMs");
+            updateLenovoPenGestureLayout("lenovoPenLongPressAction", "lenovoPenLongPressToggle", "lenovoPenLongPressDurationMs");
+            updateLenovoPenGestureLayout("lenovoPenLongPressClickAction", "lenovoPenLongPressClickToggle", "lenovoPenLongPressClickDurationMs");
+
             boolean requestNotificationPermissionVisible =
                     Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU
                     && ContextCompat.checkSelfPermission(requireContext(), POST_NOTIFICATIONS) == PERMISSION_DENIED;
             setVisible("requestNotificationPermission", requestNotificationPermissionVisible);
         }
 
+        private void updateLenovoPenGestureLayout(String actionKey, String toggleKey, String durationKey) {
+            String actionValue = prefs.get().getString(actionKey, "disabled");
+            boolean mappingEnabled = actionValue != null && !"disabled".contentEquals(actionValue);
+            setEnabled(toggleKey, mappingEnabled);
+            boolean toggle = prefs.get().getBoolean(toggleKey, false);
+            setEnabled(durationKey, mappingEnabled && !toggle);
+        }
+
         /** @noinspection SameParameterValue*/
         private void setNoActionOptionText(Preference preference, CharSequence text) {
             if (preference == null)
@@ -430,6 +462,15 @@
             if ("showAdditionalKbd".contentEquals(key) && (Boolean) newValue)
                 prefs.additionalKbdVisible.put(true);
 
+            if (key != null && key.startsWith("lenovoPen") && key.endsWith("DurationMs")) {
+                try {
+                    Integer.parseInt((String) newValue);
+                } catch (NumberFormatException ex) {
+                    Toast.makeText(getActivity(), "Please enter a number", Toast.LENGTH_SHORT).show();
+                    return false;
+                }
+            }
+
             if ("enableAccessibilityServiceAutomatically".contentEquals(key)) {
                 if (!((Boolean) newValue))
                     KeyInterceptor.shutdown(false);
Index: app/src/main/java/com/termux/x11/MainActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/termux/x11/MainActivity.java b/app/src/main/java/com/termux/x11/MainActivity.java
--- a/app/src/main/java/com/termux/x11/MainActivity.java	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/app/src/main/java/com/termux/x11/MainActivity.java	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
@@ -53,6 +53,7 @@
 import android.widget.FrameLayout;
 import android.widget.ImageButton;
 import android.widget.LinearLayout;
+import android.widget.Toast;
 
 import androidx.annotation.NonNull;
 import androidx.appcompat.app.AppCompatActivity;
@@ -60,8 +61,11 @@
 import androidx.core.math.MathUtils;
 import androidx.viewpager.widget.ViewPager;
 
+import java.util.Map;
+
 import com.termux.x11.input.InputEventSender;
 import com.termux.x11.input.InputStub;
+import com.termux.x11.input.LenovoPenButtonMapper;
 import com.termux.x11.input.TouchInputHandler;
 import com.termux.x11.utils.FullscreenWorkaround;
 import com.termux.x11.utils.KeyInterceptor;
@@ -69,8 +73,6 @@
 import com.termux.x11.utils.TermuxX11ExtraKeys;
 import com.termux.x11.utils.X11ToolbarViewPager;
 
-import java.util.Map;
-
 @SuppressLint("ApplySharedPref")
 @SuppressWarnings({"deprecation", "unused"})
 public class MainActivity extends AppCompatActivity {
@@ -93,6 +95,8 @@
     boolean useTermuxEKBarBehaviour = false;
     private boolean isInPictureInPictureMode = false;
 
+    private LenovoPenButtonMapper lenovoPenButtonMapper;
+
     public static Prefs prefs = null;
 
     private static boolean oldFullscreen = false, oldHideCutout = false;
@@ -175,6 +179,8 @@
         View lorieParent = (View) lorieView.getParent();
 
         mInputHandler = new TouchInputHandler(this, new InputEventSender(lorieView));
+        lenovoPenButtonMapper = new LenovoPenButtonMapper(this, mInputHandler);
+        lenovoPenButtonMapper.reloadPreferences(prefs);
         mLorieKeyListener = (v, k, e) -> {
             InputDevice dev = e.getDevice();
             boolean result = mInputHandler.sendKeyEvent(e);
@@ -582,6 +588,8 @@
         LorieView lorieView = getLorieView();
 
         mInputHandler.reloadPreferences(prefs);
+        if (lenovoPenButtonMapper != null)
+            lenovoPenButtonMapper.reloadPreferences(prefs);
         lorieView.reloadPreferences(prefs);
 
         setTerminalToolbarView();
@@ -687,11 +695,21 @@
     }
 
     public boolean handleKey(KeyEvent e) {
+        if (lenovoPenButtonMapper != null && lenovoPenButtonMapper.onKeyEvent(e))
+            return true;
         if (filterOutWinKey && (e.getKeyCode() == KEYCODE_META_LEFT || e.getKeyCode() == KEYCODE_META_RIGHT || e.isMetaPressed()))
             return false;
         return mLorieKeyListener.onKey(getLorieView(), e.getKeyCode(), e);
     }
 
+    @Override
+    public boolean dispatchKeyEvent(KeyEvent event) {
+        // Ensure Lenovo pen button events are intercepted even if the view key listener is bypassed.
+        if (handleKey(event))
+            return true;
+        return super.dispatchKeyEvent(event);
+    }
+
     @SuppressLint("ObsoleteSdkInt")
     Notification buildNotification() {
         NotificationCompat.Builder builder =  new NotificationCompat.Builder(this, getNotificationChannel(mNotificationManager))
@@ -911,4 +929,5 @@
             inputMethodManager.hideSoftInputFromWindow(getWindow().getDecorView().getRootView().getWindowToken(), 0);
         getLorieView().requestFocus();
     }
+
 }
Index: app/src/main/java/com/termux/x11/input/LenovoPenButtonMapper.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/termux/x11/input/LenovoPenButtonMapper.java b/app/src/main/java/com/termux/x11/input/LenovoPenButtonMapper.java
new file mode 100644
--- /dev/null	(revision 8c43d18fd5ea21df0ea5ab6940f64f61ed24471a)
+++ b/app/src/main/java/com/termux/x11/input/LenovoPenButtonMapper.java	(revision 8c43d18fd5ea21df0ea5ab6940f64f61ed24471a)
@@ -0,0 +1,241 @@
+package com.termux.x11.input;
+
+import android.content.Context;
+import android.os.Handler;
+import android.os.Looper;
+import android.view.KeyEvent;
+import android.view.MotionEvent;
+import android.widget.Toast;
+import android.util.Log;
+
+import com.termux.x11.Prefs;
+
+import java.util.EnumMap;
+import java.util.Locale;
+import java.util.Map;
+
+import dev.ilamparithi.lppdebug.helper.LenovoPenButtonListener;
+import dev.ilamparithi.lppdebug.helper.PenButtonEvent;
+
+/**
+ * Maps Lenovo pen barrel button keycodes (600-604) into stylus button state changes.
+ */
+public final class LenovoPenButtonMapper {
+    private final Context context;
+    private final TouchInputHandler inputHandler;
+    private final LenovoPenButtonListener listener;
+    private final Handler handler = new Handler(Looper.getMainLooper());
+    private final Map<PenButtonEvent, GestureConfig> configs = new EnumMap<>(PenButtonEvent.class);
+    private final Map<PenButtonEvent, Runnable> pendingReleases = new EnumMap<>(PenButtonEvent.class);
+    private int toggledMask = 0;
+    private int pressHoldMask = 0;
+    private int offOnLiftMask = 0;
+    private boolean tipDown = false;
+    private boolean showDetections;
+    private boolean showToggleDebug;
+
+    public LenovoPenButtonMapper(Context context, TouchInputHandler inputHandler) {
+        this.context = context.getApplicationContext();
+        this.inputHandler = inputHandler;
+        this.listener = new LenovoPenButtonListener(this::handlePenEvent, msg -> {});
+        this.inputHandler.addStylusStateListener(this::onStylusState);
+    }
+
+    public boolean onKeyEvent(KeyEvent event) {
+        return listener.onKeyEvent(event);
+    }
+
+    public void reloadPreferences(Prefs prefs) {
+        showDetections = prefs.lenovoPenShowDetections.get();
+        showToggleDebug = prefs.lenovoPenDebugToggleToasts.get();
+        // Clear toggle state and pending releases when preferences change so we don't carry stale bits.
+        toggledMask = 0;
+        pressHoldMask = 0;
+        offOnLiftMask = 0;
+        inputHandler.applyStylusToggleMask(0);
+        inputHandler.applyStylusHoldMask(0);
+        pendingReleases.values().forEach(handler::removeCallbacks);
+        pendingReleases.clear();
+        configs.put(PenButtonEvent.SINGLE_PRESS, buildConfig(
+                prefs.get().getString("lenovoPenSinglePressAction", "disabled"),
+                prefs.get().getBoolean("lenovoPenSinglePressToggle", false),
+            prefs.get().getBoolean("lenovoPenSinglePressToggleOffOnLift", false),
+                prefs.get().getString("lenovoPenSinglePressDurationMs", "150")));
+        configs.put(PenButtonEvent.DOUBLE_PRESS, buildConfig(
+                prefs.get().getString("lenovoPenDoublePressAction", "disabled"),
+                prefs.get().getBoolean("lenovoPenDoublePressToggle", false),
+            prefs.get().getBoolean("lenovoPenDoublePressToggleOffOnLift", false),
+                prefs.get().getString("lenovoPenDoublePressDurationMs", "150")));
+        configs.put(PenButtonEvent.TRIPLE_PRESS, buildConfig(
+                prefs.get().getString("lenovoPenTriplePressAction", "disabled"),
+                prefs.get().getBoolean("lenovoPenTriplePressToggle", false),
+            prefs.get().getBoolean("lenovoPenTriplePressToggleOffOnLift", false),
+                prefs.get().getString("lenovoPenTriplePressDurationMs", "150")));
+        configs.put(PenButtonEvent.LONG_PRESS, buildConfig(
+                prefs.get().getString("lenovoPenLongPressAction", "disabled"),
+                prefs.get().getBoolean("lenovoPenLongPressToggle", false),
+            prefs.get().getBoolean("lenovoPenLongPressToggleOffOnLift", false),
+                prefs.get().getString("lenovoPenLongPressDurationMs", "150")));
+        configs.put(PenButtonEvent.LONG_PRESS_AND_CLICK, buildConfig(
+                prefs.get().getString("lenovoPenLongPressClickAction", "disabled"),
+                prefs.get().getBoolean("lenovoPenLongPressClickToggle", false),
+            prefs.get().getBoolean("lenovoPenLongPressClickToggleOffOnLift", false),
+                prefs.get().getString("lenovoPenLongPressClickDurationMs", "150")));
+
+        validateConfigs();
+    }
+
+    private GestureConfig buildConfig(String action, boolean toggle, boolean toggleOffOnLift, String durationMs) {
+        GestureConfig cfg = new GestureConfig();
+        cfg.buttonMask = mapActionToButtonMask(action);
+        cfg.toggle = toggle;
+        cfg.toggleOffOnLift = toggleOffOnLift;
+        try {
+            cfg.durationMs = Long.parseLong(durationMs);
+        } catch (NumberFormatException e) {
+            cfg.durationMs = 150L;
+        }
+        cfg.durationMs = Math.max(10L, Math.min(8192L, cfg.durationMs));
+        return cfg;
+    }
+
+    private int mapActionToButtonMask(String action) {
+        if (action == null || "disabled".contentEquals(action))
+            return 0;
+        // Map UI actions to stylus button mask: secondary (right) -> BUTTON_SECONDARY, tertiary (middle) -> BUTTON_TERTIARY.
+        if ("2".contentEquals(action))
+            return MotionEvent.BUTTON_SECONDARY;
+        else if ("3".contentEquals(action))
+            return MotionEvent.BUTTON_TERTIARY;
+        return 0;
+    }
+
+    private void handlePenEvent(PenButtonEvent event) {
+        GestureConfig cfg = configs.get(event);
+        if (cfg == null)
+            return;
+
+        if (showDetections && !(cfg.toggle && showToggleDebug))
+            Toast.makeText(context, event.name(), Toast.LENGTH_SHORT).show();
+
+        if (cfg.buttonMask == 0)
+            return;
+
+        Runnable pending = pendingReleases.remove(event);
+        if (pending != null)
+            handler.removeCallbacks(pending);
+
+        // Latest gesture wins: cancel pending releases touching the same buttons.
+        cancelPendingForButtons(cfg.buttonMask);
+
+        if (cfg.toggle) {
+            applyToggle(cfg.buttonMask, event);
+        } else {
+            applyPress(cfg.buttonMask, cfg.durationMs, event);
+        }
+    }
+
+    private void cancelPendingForButtons(int buttonMask) {
+        for (Map.Entry<PenButtonEvent, GestureConfig> entry : configs.entrySet()) {
+            Runnable pending = pendingReleases.get(entry.getKey());
+            if (pending == null)
+                continue;
+            GestureConfig cfg = entry.getValue();
+            if (cfg != null && (cfg.buttonMask & buttonMask) != 0) {
+                handler.removeCallbacks(pending);
+                pendingReleases.remove(entry.getKey());
+            }
+        }
+    }
+
+    private void applyToggle(int buttonMask, PenButtonEvent event) {
+        // Toggle overrides any active press on the same buttons.
+        if ((pressHoldMask & buttonMask) != 0) {
+            pressHoldMask &= ~buttonMask;
+            inputHandler.applyStylusHoldMask(pressHoldMask);
+        }
+        toggledMask ^= buttonMask;
+        boolean on = (toggledMask & buttonMask) != 0;
+        inputHandler.applyStylusToggleMask(toggledMask);
+
+        GestureConfig cfg = configs.get(event);
+        if (cfg != null && cfg.toggleOffOnLift) {
+            if (on)
+                offOnLiftMask |= buttonMask;
+            else
+                offOnLiftMask &= ~buttonMask;
+        } else {
+            offOnLiftMask &= ~buttonMask;
+        }
+
+        if (showToggleDebug) {
+            String msg = String.format(Locale.US, "%s toggle %d %s", event.name(), buttonMask, on ? "ON" : "OFF");
+            Toast.makeText(context, msg, Toast.LENGTH_SHORT).show();
+        }
+    }
+
+    private void applyPress(int buttonMask, long durationMs, PenButtonEvent event) {
+        // Press overrides toggle state for these buttons.
+        if ((toggledMask & buttonMask) != 0) {
+            toggledMask &= ~buttonMask;
+            inputHandler.applyStylusToggleMask(toggledMask);
+        }
+        offOnLiftMask &= ~buttonMask;
+        pressHoldMask |= buttonMask;
+        inputHandler.applyStylusHoldMask(pressHoldMask);
+
+        Runnable release = () -> {
+            pressHoldMask &= ~buttonMask;
+            inputHandler.applyStylusHoldMask(pressHoldMask);
+        };
+        pendingReleases.put(event, release);
+        handler.postDelayed(release, Math.max(0, durationMs));
+    }
+
+    private static final class GestureConfig {
+        int buttonMask;
+        boolean toggle;
+        boolean toggleOffOnLift;
+        long durationMs;
+    }
+
+    private void onStylusState(StylusState state) {
+        boolean nowTipDown = (state.buttons & MotionEvent.BUTTON_PRIMARY) != 0 || state.pressure > 0;
+        boolean wasTipDown = tipDown;
+        tipDown = nowTipDown;
+
+        if (!wasTipDown && nowTipDown) {
+            // Arm cycle; nothing else needed.
+            return;
+        }
+
+        if (wasTipDown && !nowTipDown && offOnLiftMask != 0) {
+            int mask = offOnLiftMask;
+            toggledMask &= ~mask;
+            offOnLiftMask &= ~mask;
+            inputHandler.applyStylusToggleMask(toggledMask);
+            StylusState current = inputHandler.getLastStylusState();
+            int targetButtons = current.buttons & ~mask;
+            inputHandler.sendStylusButtons(targetButtons);
+        }
+    }
+
+    private void validateConfigs() {
+        // Disable conflicting mappings: same button mask with the same mode.
+        PenButtonEvent[] events = PenButtonEvent.values();
+        for (int i = 0; i < events.length; i++) {
+            GestureConfig a = configs.get(events[i]);
+            if (a == null || a.buttonMask == 0)
+                continue;
+            for (int j = i + 1; j < events.length; j++) {
+                GestureConfig b = configs.get(events[j]);
+                if (b == null || b.buttonMask == 0)
+                    continue;
+                if (a.buttonMask == b.buttonMask && a.toggle == b.toggle) {
+                    Log.w("LenovoPenButtonMapper", "Conflicting mapping for " + events[i] + " and " + events[j] + " with mask " + a.buttonMask + " and mode " + (a.toggle ? "toggle" : "press") + "; disabling " + events[j]);
+                    b.buttonMask = 0;
+                }
+            }
+        }
+    }
+}
Index: app/src/main/java/com/termux/x11/input/StylusState.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/termux/x11/input/StylusState.java b/app/src/main/java/com/termux/x11/input/StylusState.java
new file mode 100644
--- /dev/null	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
+++ b/app/src/main/java/com/termux/x11/input/StylusState.java	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
@@ -0,0 +1,39 @@
+package com.termux.x11.input;
+
+public final class StylusState {
+    public float x;
+    public float y;
+    public int pressure;
+    public int tiltX;
+    public int tiltY;
+    public int orientation;
+    public int buttons;
+    public boolean eraser;
+    public boolean mouse;
+
+    public StylusState() {}
+
+    public StylusState copy() {
+        StylusState copy = new StylusState();
+        copy.setFrom(this);
+        return copy;
+    }
+
+    public StylusState withButtons(int newButtons) {
+        StylusState copy = copy();
+        copy.buttons = newButtons;
+        return copy;
+    }
+
+    public void setFrom(StylusState other) {
+        x = other.x;
+        y = other.y;
+        pressure = other.pressure;
+        tiltX = other.tiltX;
+        tiltY = other.tiltY;
+        orientation = other.orientation;
+        buttons = other.buttons;
+        eraser = other.eraser;
+        mouse = other.mouse;
+    }
+}
Index: app/src/main/java/com/termux/x11/input/TouchInputHandler.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/termux/x11/input/TouchInputHandler.java b/app/src/main/java/com/termux/x11/input/TouchInputHandler.java
--- a/app/src/main/java/com/termux/x11/input/TouchInputHandler.java	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/app/src/main/java/com/termux/x11/input/TouchInputHandler.java	(revision 8c43d18fd5ea21df0ea5ab6940f64f61ed24471a)
@@ -41,6 +41,7 @@
 import java.lang.annotation.RetentionPolicy;
 import java.lang.reflect.InvocationTargetException;
 import java.util.Arrays;
+import java.util.ArrayList;
 import java.util.Objects;
 import java.util.concurrent.atomic.AtomicBoolean;
 import java.util.function.BiConsumer;
@@ -92,6 +93,11 @@
     private final InputEventSender mInjector;
     private final MainActivity mActivity;
     private final DisplayMetrics mMetrics = new DisplayMetrics();
+    private final StylusState lastStylusState = new StylusState();
+    private final StylusState lastRawStylusState = new StylusState();
+    private int stylusToggleMask = 0;
+    private int stylusHoldMask = 0;
+    private final ArrayList<StylusStateListener> stylusStateListeners = new ArrayList<>();
 
     private final BiConsumer<Integer, Boolean> noAction = (key, down) -> {};
     private BiConsumer<Integer, Boolean> swipeUpAction = noAction, swipeDownAction = noAction,
@@ -174,6 +180,11 @@
         mRenderData = renderData != null ? renderData :new RenderData();
         mInjector = injector;
         mActivity = activity;
+        PointF cursor = mRenderData.getCursorPosition();
+        lastStylusState.x = cursor.x;
+        lastStylusState.y = cursor.y;
+        lastStylusState.mouse = mInjector.stylusIsMouse;
+        lastRawStylusState.setFrom(lastStylusState);
         if (mDisplayManager == null) {
             mDisplayManager = (DisplayManager) mActivity.getSystemService(Context.DISPLAY_SERVICE);
             mDisplayRotation = mDisplayManager.getDisplay(Display.DEFAULT_DISPLAY).getRotation() % 4;
@@ -432,6 +443,7 @@
         mInjector.capturedPointerSpeedFactor = ((float) p.capturedPointerSpeedFactor.get())/100;
         mInjector.dexMetaKeyCapture = p.dexMetaKeyCapture.get();
         mInjector.stylusIsMouse = p.stylusIsMouse.get();
+        lastStylusState.mouse = mInjector.stylusIsMouse;
         mInjector.stylusButtonContactModifierMode = p.stylusButtonContactModifierMode.get();
         mInjector.pauseKeyInterceptingWithEsc = p.pauseKeyInterceptingWithEsc.get();
         switch (p.transformCapturedPointer.get()) {
@@ -972,21 +984,101 @@
             }
 
             android.util.Log.d("STYLUS_EVENT", "action " + action + " x " + newX + " y " + newY + " pressure " + e.getPressure() + " tilt " + e.getAxisValue(MotionEvent.AXIS_TILT) + " orientation " + e.getAxisValue(MotionEvent.AXIS_ORIENTATION) + " buttonState " + e.getButtonState() + " extractedButtons " + newButtons);
-            mInjector.sendStylusEvent(
-                    x = newX,
-                    y = newY,
-                    (int) ((pressure = e.getPressure()) * 65535),
-                    tiltX,
-                    tiltY,
-                    convertOrientation(orientation),
-                    buttons = newButtons,
-                    e.getToolType(e.getActionIndex()) == MotionEvent.TOOL_TYPE_ERASER,
-                    mInjector.stylusIsMouse);
+            StylusState state = new StylusState();
+            x = newX;
+            y = newY;
+            pressure = e.getPressure();
+            buttons = newButtons;
+            state.x = x;
+            state.y = y;
+            state.pressure = (int) (pressure * 65535);
+            state.tiltX = tiltX;
+            state.tiltY = tiltY;
+            state.orientation = convertOrientation(orientation);
+            state.buttons = newButtons;
+            state.eraser = e.getToolType(e.getActionIndex()) == MotionEvent.TOOL_TYPE_ERASER;
+            state.mouse = mInjector.stylusIsMouse;
+            sendStylusState(state);
 
             return true;
         }
     }
 
+    public StylusState getLastStylusState() {
+        return lastStylusState.copy();
+    }
+
+    public StylusState getLastRawStylusState() {
+        return lastRawStylusState.copy();
+    }
+
+    public void addStylusStateListener(StylusStateListener listener) {
+        if (listener != null && !stylusStateListeners.contains(listener))
+            stylusStateListeners.add(listener);
+    }
+
+    public void removeStylusStateListener(StylusStateListener listener) {
+        stylusStateListeners.remove(listener);
+    }
+
+    public int getStylusToggleMask() {
+        return stylusToggleMask;
+    }
+
+    public void applyStylusToggleMask(int mask) {
+        stylusToggleMask = mask;
+        // Re-send current state so the overlay takes effect immediately.
+        sendStylusState(getLastRawStylusState());
+    }
+
+    public void applyStylusHoldMask(int mask) {
+        stylusHoldMask = mask;
+        // Re-send current state so the overlay takes effect immediately.
+        sendStylusState(getLastRawStylusState());
+    }
+
+    public void sendStylusState(StylusState state) {
+        if (state == null)
+            return;
+
+        StylusState next = state.copy();
+        if (Float.isNaN(next.x) || Float.isNaN(next.y)) {
+            PointF cursor = mRenderData.getCursorPosition();
+            next.x = cursor.x;
+            next.y = cursor.y;
+        }
+
+        if (!next.mouse)
+            next.mouse = mInjector.stylusIsMouse;
+
+        next.buttons |= stylusToggleMask;
+        StylusState raw = next.copy();
+        raw.buttons &= ~(stylusToggleMask | stylusHoldMask);
+        lastRawStylusState.setFrom(raw);
+
+        int baseButtons = raw.buttons;
+        next.buttons = baseButtons | stylusToggleMask | stylusHoldMask;
+
+        lastStylusState.setFrom(next);
+        mInjector.sendStylusEvent(next.x, next.y, next.pressure, next.tiltX, next.tiltY, next.orientation, next.buttons, next.eraser, next.mouse);
+
+        if (!stylusStateListeners.isEmpty()) {
+            StylusState dispatch = next.copy();
+            for (StylusStateListener listener : new ArrayList<>(stylusStateListeners))
+                listener.onStylusState(dispatch);
+        }
+    }
+
+    public interface StylusStateListener {
+        void onStylusState(StylusState state);
+    }
+
+    public void sendStylusButtons(int newButtons) {
+        StylusState next = getLastStylusState();
+        next.buttons = newButtons;
+        sendStylusState(next);
+    }
+
     /** @noinspection NullableProblems*/
     private class DexListener extends GestureDetector.SimpleOnGestureListener {
         private final GestureDetector mScroller;
Index: app/src/main/java/dev/ilamparithi/lppdebug/helper/LenovoPenButtonListener.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/dev/ilamparithi/lppdebug/helper/LenovoPenButtonListener.java b/app/src/main/java/dev/ilamparithi/lppdebug/helper/LenovoPenButtonListener.java
new file mode 100644
--- /dev/null	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
+++ b/app/src/main/java/dev/ilamparithi/lppdebug/helper/LenovoPenButtonListener.java	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
@@ -0,0 +1,67 @@
+package dev.ilamparithi.lppdebug.helper;
+
+import android.view.KeyEvent;
+
+import java.util.function.Consumer;
+
+/**
+ * Portable listener for Lenovo Pen Plus button keycodes (600-604).
+ * Emits a single event per gesture and consumes the KeyEvent when handled.
+ */
+public class LenovoPenButtonListener {
+    private final Consumer<PenButtonEvent> onButtonPressed;
+    private final Consumer<String> onDebug;
+    private Integer pendingKeyCode = null;
+    private long lastEmittedAt = 0L;
+
+    public LenovoPenButtonListener(Consumer<PenButtonEvent> onButtonPressed, Consumer<String> onDebug) {
+        this.onButtonPressed = onButtonPressed;
+        this.onDebug = onDebug;
+    }
+
+    /**
+     * Drop-in handler for dispatchKeyEvent() or onKeyUp().
+     * Consumes stylus keycodes 600-604 and emits exactly once per press.
+     */
+    public boolean onKeyEvent(KeyEvent event) {
+        if (event == null || !isLenovoPenButton(event.getKeyCode()))
+            return false;
+
+        if (event.getRepeatCount() > 0)
+            return true; // ignore repeats to avoid noise
+
+        switch (event.getAction()) {
+            case KeyEvent.ACTION_DOWN:
+                pendingKeyCode = event.getKeyCode();
+                debug("Pen button DOWN code=" + event.getKeyCode());
+                return true;
+            case KeyEvent.ACTION_UP:
+                int codeToEmit = pendingKeyCode != null ? pendingKeyCode : event.getKeyCode();
+                pendingKeyCode = null;
+                PenButtonEvent.fromKeyCode(codeToEmit).ifPresent(buttonEvent -> {
+                    if (event.getEventTime() != lastEmittedAt) {
+                        lastEmittedAt = event.getEventTime();
+                        onButtonPressed.accept(buttonEvent);
+                        debug("Pen button UP code=" + codeToEmit + " -> " + buttonEvent);
+                    }
+                });
+                return true;
+            default:
+                return false;
+        }
+    }
+
+    /** Convenience wrapper matching Activity.onKeyUp signature. */
+    public boolean onKeyUp(int keyCode, KeyEvent event) {
+        return onKeyEvent(event);
+    }
+
+    private boolean isLenovoPenButton(int keyCode) {
+        return keyCode >= 600 && keyCode <= 604;
+    }
+
+    private void debug(String msg) {
+        if (onDebug != null)
+            onDebug.accept(msg);
+    }
+}
Index: app/src/main/java/dev/ilamparithi/lppdebug/helper/PenButtonEvent.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/dev/ilamparithi/lppdebug/helper/PenButtonEvent.java b/app/src/main/java/dev/ilamparithi/lppdebug/helper/PenButtonEvent.java
new file mode 100644
--- /dev/null	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
+++ b/app/src/main/java/dev/ilamparithi/lppdebug/helper/PenButtonEvent.java	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
@@ -0,0 +1,26 @@
+package dev.ilamparithi.lppdebug.helper;
+
+import java.util.Arrays;
+import java.util.Optional;
+
+public enum PenButtonEvent {
+    SINGLE_PRESS(600),
+    DOUBLE_PRESS(601),
+    TRIPLE_PRESS(602),
+    LONG_PRESS(603),
+    LONG_PRESS_AND_CLICK(604);
+
+    private final int keyCode;
+
+    PenButtonEvent(int keyCode) {
+        this.keyCode = keyCode;
+    }
+
+    public int getKeyCode() {
+        return keyCode;
+    }
+
+    public static Optional<PenButtonEvent> fromKeyCode(int keyCode) {
+        return Arrays.stream(values()).filter(v -> v.keyCode == keyCode).findFirst();
+    }
+}
Index: app/src/main/res/values/arrays.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/values/arrays.xml b/app/src/main/res/values/arrays.xml
--- a/app/src/main/res/values/arrays.xml	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/app/src/main/res/values/arrays.xml	(revision f9daafcfc3ad7b2d39cbb7b728bc5ad27afcf62d)
@@ -85,4 +85,14 @@
         <item>reverse portrait</item>
         <item>reverse landscape</item>
     </string-array>
+    <string-array name="lenovoPenActionEntries">
+        <item>Disabled</item>
+        <item>Barrel Primary (Button 2)</item>
+        <item>Barrel Secondary (Button 3)</item>
+    </string-array>
+    <string-array name="lenovoPenActionValues">
+        <item>disabled</item>
+        <item>2</item>
+        <item>3</item>
+    </string-array>
 </resources>
Index: app/src/main/res/values/strings.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
--- a/app/src/main/res/values/strings.xml	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/app/src/main/res/values/strings.xml	(revision 29b7982ba006a6eb936316d422eaba6c6dd344f7)
@@ -34,6 +34,7 @@
     <string name="pref_version">Version</string>
     <string name="pref_ekbar">Extra key bar preferences</string>
     <string name="pref_userActions">Response to user actions</string>
+    <string name="pref_lenovoPenMapping">Lenovo pen mapping</string>
 
     <string name="pref_displayResolutionMode">Display resolution mode</string>
     <string name="pref_displayScale">Display scale, %</string>
@@ -66,6 +67,25 @@
     <string name="pref_transformCapturedPointer">Transform captured pointer movements</string>
     <string name="pref_capturedPointerSpeedFactor">Captured pointer speed factor, %</string>
     <string name="pref_tapToMove">Enable tap-to-move for touchpads</string>
+    <string name="pref_lenovoPenShowDetections">Show detections on screen</string>
+    <string name="pref_lenovoPenShowDetections_summary">Show toast for detected gestures</string>
+    <string name="pref_lenovoPenDebugToggleToasts">Show debug toggle toasts</string>
+    <string name="pref_lenovoPenDebugToggleToasts_summary">Show gesture/button state and hold duration when Lenovo pen mapping fires</string>
+    <string name="pref_lenovoPenGestureMappings">Gesture mappings</string>
+    <string name="pref_lenovoPenMapTo">Map to</string>
+    <string name="pref_lenovoPenToggleTitle">Toggle target button</string>
+    <string name="pref_lenovoPenToggleSummary">Off: press and hold target for the specified duration. On: toggle, gesture once for down and again for up.</string>
+    <string name="pref_lenovoPenToggleSummary_off">Off: press and hold target for the specified duration.</string>
+    <string name="pref_lenovoPenToggleSummary_on">On: toggle, gesture once for down and again for up.</string>
+    <string name="pref_lenovoPenToggleOffOnLiftTitle">Toggle OFF on lift</string>
+    <string name="pref_lenovoPenToggleOffOnLiftSummary">When toggled on and pen lifts after contact, release the mapped button automatically.</string>
+    <string name="pref_lenovoPenDurationTitle">Hold duration (ms)</string>
+    <string name="pref_lenovoPenDurationDialog">Hold duration in milliseconds</string>
+    <string name="pref_lenovoPenSinglePressTitle">Single Press (600)</string>
+    <string name="pref_lenovoPenDoublePressTitle">Double Press (601)</string>
+    <string name="pref_lenovoPenTriplePressTitle">Triple Press (602)</string>
+    <string name="pref_lenovoPenLongPressTitle">Long Press (603)</string>
+    <string name="pref_lenovoPenLongPressClickTitle">Long Press and Click (604)</string>
 
     <string name="pref_showAdditionalKbd">Show additional keyboard</string>
     <string name="pref_showAdditionalKbd_summary">Show keyboard with additional keys.</string>
Index: app/src/main/res/xml/preferences.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/xml/preferences.xml b/app/src/main/res/xml/preferences.xml
--- a/app/src/main/res/xml/preferences.xml	(revision 6d627520b4717cdea1ed1530e6d063be7537cc8b)
+++ b/app/src/main/res/xml/preferences.xml	(revision 29b7982ba006a6eb936316d422eaba6c6dd344f7)
@@ -34,6 +34,7 @@
         <ListPreference app:key="transformCapturedPointer" app:defaultValue="no" app:entries="@array/transformCapturedPointerEntries" app:entryValues="@array/transformCapturedPointerValues" />
         <SeekBarPreference app:key="capturedPointerSpeedFactor" app:defaultValue="100" app:min="1" android:max="300" app:seekBarIncrement="1" app:showSeekBarValue="true" app:updatesContinuously="true" />
         <SwitchPreferenceCompat app:key="tapToMove" app:defaultValue="false" />
+        <Preference app:key="lenovoPenMappingEntry" app:title="@string/pref_lenovoPenMapping" app:fragment="lenovoPenMapping" />
     </PreferenceScreen>
     <PreferenceScreen app:key="kbd">
         <SwitchPreferenceCompat app:key="showAdditionalKbd" app:defaultValue="true" />
@@ -74,4 +75,55 @@
         <ListPreference app:key="notificationButton1Action" app:defaultValue="exit" app:entries="@array/userActionsValues" app:entryValues="@array/userActionsValues" />
         <ListPreference app:key="mediaKeysAction" app:defaultValue="no action" app:entries="@array/userActionsMediaKeyValues" app:entryValues="@array/userActionsMediaKeyValues" />
     </PreferenceScreen>
+
+    <PreferenceScreen app:key="lenovoPenMapping" app:title="@string/pref_lenovoPenMapping">
+        <SwitchPreferenceCompat
+            app:key="lenovoPenShowDetections"
+            app:defaultValue="false"
+            app:title="@string/pref_lenovoPenShowDetections"
+            app:summary="@string/pref_lenovoPenShowDetections_summary" />
+
+        <SwitchPreferenceCompat
+            app:key="lenovoPenDebugToggleToasts"
+            app:defaultValue="false"
+            app:title="@string/pref_lenovoPenDebugToggleToasts"
+            app:summary="@string/pref_lenovoPenDebugToggleToasts_summary" />
+
+        <Preference app:key="lenovoPenGestureMappings" app:title="@string/pref_lenovoPenGestureMappings" app:selectable="false" app:enabled="false" />
+
+        <PreferenceCategory app:title="@string/pref_lenovoPenSinglePressTitle">
+            <ListPreference app:key="lenovoPenSinglePressAction" app:defaultValue="disabled" app:title="@string/pref_lenovoPenMapTo" app:entries="@array/lenovoPenActionEntries" app:entryValues="@array/lenovoPenActionValues" app:useSimpleSummaryProvider="true" />
+            <SwitchPreferenceCompat app:key="lenovoPenSinglePressToggle" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleTitle" app:summary="@string/pref_lenovoPenToggleSummary" />
+            <SwitchPreferenceCompat app:key="lenovoPenSinglePressToggleOffOnLift" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleOffOnLiftTitle" app:summary="@string/pref_lenovoPenToggleOffOnLiftSummary" />
+            <EditTextPreference app:key="lenovoPenSinglePressDurationMs" app:defaultValue="150" app:title="@string/pref_lenovoPenDurationTitle" app:dialogTitle="@string/pref_lenovoPenDurationDialog" app:useSimpleSummaryProvider="true" android:inputType="number" />
+        </PreferenceCategory>
+
+        <PreferenceCategory app:title="@string/pref_lenovoPenDoublePressTitle">
+            <ListPreference app:key="lenovoPenDoublePressAction" app:defaultValue="disabled" app:title="@string/pref_lenovoPenMapTo" app:entries="@array/lenovoPenActionEntries" app:entryValues="@array/lenovoPenActionValues" app:useSimpleSummaryProvider="true" />
+            <SwitchPreferenceCompat app:key="lenovoPenDoublePressToggle" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleTitle" app:summary="@string/pref_lenovoPenToggleSummary" />
+            <SwitchPreferenceCompat app:key="lenovoPenDoublePressToggleOffOnLift" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleOffOnLiftTitle" app:summary="@string/pref_lenovoPenToggleOffOnLiftSummary" />
+            <EditTextPreference app:key="lenovoPenDoublePressDurationMs" app:defaultValue="150" app:title="@string/pref_lenovoPenDurationTitle" app:dialogTitle="@string/pref_lenovoPenDurationDialog" app:useSimpleSummaryProvider="true" android:inputType="number" />
+        </PreferenceCategory>
+
+        <PreferenceCategory app:title="@string/pref_lenovoPenTriplePressTitle">
+            <ListPreference app:key="lenovoPenTriplePressAction" app:defaultValue="disabled" app:title="@string/pref_lenovoPenMapTo" app:entries="@array/lenovoPenActionEntries" app:entryValues="@array/lenovoPenActionValues" app:useSimpleSummaryProvider="true" />
+            <SwitchPreferenceCompat app:key="lenovoPenTriplePressToggle" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleTitle" app:summary="@string/pref_lenovoPenToggleSummary" />
+            <SwitchPreferenceCompat app:key="lenovoPenTriplePressToggleOffOnLift" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleOffOnLiftTitle" app:summary="@string/pref_lenovoPenToggleOffOnLiftSummary" />
+            <EditTextPreference app:key="lenovoPenTriplePressDurationMs" app:defaultValue="150" app:title="@string/pref_lenovoPenDurationTitle" app:dialogTitle="@string/pref_lenovoPenDurationDialog" app:useSimpleSummaryProvider="true" android:inputType="number" />
+        </PreferenceCategory>
+
+        <PreferenceCategory app:title="@string/pref_lenovoPenLongPressTitle">
+            <ListPreference app:key="lenovoPenLongPressAction" app:defaultValue="disabled" app:title="@string/pref_lenovoPenMapTo" app:entries="@array/lenovoPenActionEntries" app:entryValues="@array/lenovoPenActionValues" app:useSimpleSummaryProvider="true" />
+            <SwitchPreferenceCompat app:key="lenovoPenLongPressToggle" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleTitle" app:summary="@string/pref_lenovoPenToggleSummary" />
+            <SwitchPreferenceCompat app:key="lenovoPenLongPressToggleOffOnLift" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleOffOnLiftTitle" app:summary="@string/pref_lenovoPenToggleOffOnLiftSummary" />
+            <EditTextPreference app:key="lenovoPenLongPressDurationMs" app:defaultValue="150" app:title="@string/pref_lenovoPenDurationTitle" app:dialogTitle="@string/pref_lenovoPenDurationDialog" app:useSimpleSummaryProvider="true" android:inputType="number" />
+        </PreferenceCategory>
+
+        <PreferenceCategory app:title="@string/pref_lenovoPenLongPressClickTitle">
+            <ListPreference app:key="lenovoPenLongPressClickAction" app:defaultValue="disabled" app:title="@string/pref_lenovoPenMapTo" app:entries="@array/lenovoPenActionEntries" app:entryValues="@array/lenovoPenActionValues" app:useSimpleSummaryProvider="true" />
+            <SwitchPreferenceCompat app:key="lenovoPenLongPressClickToggle" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleTitle" app:summary="@string/pref_lenovoPenToggleSummary" />
+            <SwitchPreferenceCompat app:key="lenovoPenLongPressClickToggleOffOnLift" app:defaultValue="false" app:title="@string/pref_lenovoPenToggleOffOnLiftTitle" app:summary="@string/pref_lenovoPenToggleOffOnLiftSummary" />
+            <EditTextPreference app:key="lenovoPenLongPressClickDurationMs" app:defaultValue="150" app:title="@string/pref_lenovoPenDurationTitle" app:dialogTitle="@string/pref_lenovoPenDurationDialog" app:useSimpleSummaryProvider="true" android:inputType="number" />
+        </PreferenceCategory>
+    </PreferenceScreen>
 </PreferenceScreen>
Index: build.gradle
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
